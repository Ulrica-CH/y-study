# 网络层

路由选择，逻辑寻址，分片重组，跨网段通信

## 数据分组/包

### 分片重组（Fragmentation and Reassembly）

> 是指在 IP 网络中，当数据包太大无法直接通过某个网络时，将其拆分成更小的片段进行传输，最后在目标处再还原成原始数据包的过程

- 不同网络的最大传输单元（MTU）不同

- 检查数据包大小是否超过 MTU，如果超过，就将数据包分成多个小片段（每片都带有自己的 IP 头部）

- 每个分片包含
  原始数据包的标识（Identification）
  分片偏移量（Fragment Offset）
  标志位（Flags，标明是否还有后续分片）

## 路由寻址（Routing）

> 是指数据包在网络中从源主机到目标主机的转发路径选择过程。它是网络层（如 IP 协议）的核心功能之一，确保数据能够跨越多个网络、多个路由器，最终到达目标。

- 1 、主机发包
  源主机根据目标 IP 地址，决定数据包是发给本地网络的主机，还是发给网关（路由器）。
  2 、路由器接收数据包
  路由器收到数据包后，查看数据包的目标 IP 地址。
  3 、查找路由表
  路由器根据目标 IP 地址，在自己的路由表中查找最合适的下一跳（Next Hop）和出接口。
  路由表记录了哪些网络通过哪个接口、哪个下一跳可以到达。
  路由表可以是静态配置的，也可以通过动态路由协议（如 OSPF、BGP、RIP）自动学习。
  4 、转发数据包
  路由器将数据包转发到下一个路由器或目标主机，直到数据包到达最终目的地。
  5 、多次转发
  数据包可能经过多个路由器，每个路由器都重复"查表-转发"的过程，直到到达目标。

## 路由器/网关

### 逻辑寻址

- 交换机是靠 MAC 来寻址的，而因为 MAC 地址是无层次的,所以要靠 IP 地址来确认计算机的位置,这就是选址

## 网络协议

### IP

### APR 协议

- TCP/IP 协议族中的一个网络层协议，其主要作用是在局域网（LAN）中通过已知的 IP 地址解析出对应的 MAC 地址（物理地址），以便数据包能够正确地通过以太网进行传输

- 只会在局域网里使用，采用广播的方式

- ARP 缓存有老化机制，定期清除不用的条目。
  存在 ARP 欺骗（ARP spoofing）等安全隐患。

- 主机 A 找主机 B，发送 ARP 包，第一次 目标 MAC 地址为全 0

### ICMP

- ICMP 是网络层的重要协议，用于网络诊断和错误报告。
  主要用于 ping、traceroute 等网络工具。

## IP 地址

### IPV4

- 32 位（4 字节），通常写作 4 段十进制数（如 192.168.1.1），总共约 42 亿（2³²）个地址，点分十进制（如 192.168.0.1）

- 组成：网络部分(NETWORK)，主机部分(HOST)

  - 网络部分是由 Internet 地址分配机构来统一分配的，这样可以保证 IP 的唯一性

- IP 地址分类

  - A 类

    - 1.0.0.0 ~ 126.255.255.255

      - 网络号.主机号.主机号.主机号

        - A 类私有 IP

          - 10.0.0.0 ~ 10.255.255.255

  - B 类

    - 128.0.0.0 ~ 191.255.255.255

      - 网络号.网络号.主机号.主机号

        - B 类私有 IP

          - 172.16.0.0 ~ 172.31.255.255

  - C 类

    - 192.0.0.0 ~ 223.255.255.255

      - 网络号.网络号.网络号.主机号

        - C 类私有 IP

          - 192.168.0.0 ~ 192.168.255.255

  - D 类

    - 224.0.0.0 ~ 239.255.255.255

  - E 类

    - 240.0.0.0 ~ 255.255.255.255

  - 127.x.x.x 为环回地址（loopback），不分配给网络使用。 0.x.x.x 为保留地址。

### 子网掩码

- 用来划分 IP 地址的网络部分和主机部分的一个 32 位数（IPv4），它和 IP 地址一起使用，决定了一个 IP 地址属于哪个网络、同一网络内有哪些主机

- 类型 子网掩码 二进制表示 可用主机数

- A 类 255.0.0.0 11111111.00000000.00000000.00000000 16777214
- B 类 255.255.0.0 11111111.11111111.00000000.00000000 65534
- C 类 255.255.255.0 11111111.11111111.11111111.00000000 254

- 可以用"斜线记法"表示，比如 192.168.1.0/24，意思是前 24 位为网络号，等价于子网掩码 255.255.255.0

- 按位与运算：
  192.168.1.10 & 255.255.255.0 = 192.168.1.0
  得到的 192.168.1.0 就是网络地址
  判断同一子网：
  只要两个 IP 和子网掩码按位与的结果相同，就在同一子网。

### IPV6

- 128 位（16 字节），通常写作 8 组 16 进制数（如 2001:0db8:85a3:0000:0000:8a2e:0370:7334），地址数量极其庞大（2¹²⁸），冒号分隔的 8 组 16 进制（如 2001:0db8:0000:0000:0000:ff00:0042:8329），可以简写（如 2001:db8::ff00:42:8329）

## IP 协议详解

### IP 协议特点

- **无连接**：发送前不需要建立连接
- **不可靠**：不保证数据包按序到达，不保证不丢失
- **尽力而为**：尽最大努力传输数据包

### IP 头部结构

- **版本号**：4 位，标识 IP 版本（IPv4 为 4）
- **头部长度**：4 位，以 4 字节为单位
- **服务类型**：8 位，标识优先级和服务质量
- **总长度**：16 位，整个 IP 数据包的长度
- **标识**：16 位，用于分片重组
- **标志**：3 位，控制分片行为
- **片偏移**：13 位，分片在原始数据包中的位置
- **生存时间**：8 位，TTL，防止数据包无限循环
- **协议**：8 位，标识上层协议（TCP=6，UDP=17）
- **头部校验和**：16 位，校验头部完整性
- **源 IP 地址**：32 位
- **目标 IP 地址**：32 位
- **选项**：可变长度

## 网络层常见问题

### MTU 相关问题

- **MTU 概念**：最大传输单元，网络能传输的最大数据包大小
- **常见 MTU 值**：
  - 以太网：1500 字节
  - PPPoE：1492 字节
  - 无线网络：2312 字节
- **MTU 发现**：通过 ICMP 消息发现路径 MTU
- **分片影响**：分片会增加网络开销，降低传输效率

### 路由表结构

- **目标网络**：要到达的网络地址
- **子网掩码**：网络地址的掩码
- **下一跳**：下一个路由器的 IP 地址
- **接口**：出接口名称
- **度量值**：路由成本或优先级

### 路由协议对比

- **RIP**：距离向量协议，最大跳数 15
- **OSPF**：链路状态协议，支持大型网络
- **BGP**：边界网关协议，用于自治系统间
